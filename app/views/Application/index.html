#{extends 'main.html' /}
#{set title:'Digital Kanban Board' /}

<style>
	${cssStr} { list-style-type: none; margin: 5px 5px 5px 5px; padding: 0; float: auto; }
	${cssStr2} { margin: 5px 5px 5px 5px; padding: 25px; font-size: 1.2em; float: auto; margin-right: auto; margin-left: auto; }

.styled {
	width: 93%;
	height: 45px;
	background: repeat-x scroll 50% 50% #FFFFFF;
    border-radius: 6px 6px 6px 6px;
    color: #1C94C4;
    font-weight: bold;
    outline: medium none;
    resize: none; 
	
}

.styled:focus {
	background: #ffffff;
	background: -moz-linear-gradient(top, #ffffff 0%, #ffffff 20%); /* firefox */
	background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(20%,#ffffff)); /* webkit */
	float: auto; margin-right: auto; margin-left: auto;
}

.about {
	  color:inherit;
	  font-size:16px;
	  font-weight:100;
	  line-height:27px;
	 font-family: 'Merriweather', serif; 
}

#fontme {
	  font-size:14px;
	  font-weight:bold;
}
</style>	
<div class="container">
	<div class="hero-unit-myversion">	
		<div class="row-fluid">
			<!-- Loop starts here -->
			#{list items:noterows, as:'noterow'}

			<div class="span3 main-area">
				<h2>${noterow.title}</h2>
				<ul id="sortable${noterow.id}" cleanid="${noterow.id}" class="connectedSortable posRow${noterow.id} myDiver">
				
					#{list items:noterow.notes, as:'note'}
						<li onmouseover="javascript:borderEffectAdd(${note.id})" onmouseout="javascript:borderEffectRemove(${note.id})" id="${note.id}" positionInRow="${note.positionInRow}" class="note">
						<div class="topCorner"><a id="del${note.id}" onclick="javascript:deleteMe(${note.id})" rel="popover" title="Delete Note" data-content="Click here to delete the note!" style="float: right;" href="#">
						<span class="closeMe"/>x</a></div>
						<a class="edit${note.id}" id="fontme" rel="popover" onclick="javascript:editMe(${note.id}, '${note.title}')" title="Edit Note" data-content="Click here to edit the note!" href="#">${note.title}</a></li> 
					#{/list}
					
				</ul>
							<div id="addToggle${noterow.id}" style="display: none" class="input">
								<textarea onkeypress="onKeyChange(event);" class="styled" name="addnote${noterow.id}"
									id="addnote${noterow.id}"></textarea>
									<br/>
									<input type="button" class="btn" id="button${noterow.id}" onClick="javascript:sendIt('${noterow.id}')" value="Add">
					
							</div>
						
				<a id="addNoteToggle${noterow.id}" onclick="javascript:toggleAdd('${noterow.id}')" class="btn" href="#">Add Note</a>
			</div>		
			#{/list}					
		</div>
		<!-- Loop ends here -->
	</div>

<div style="visible: none" id="identifyStr"></div>

	<hr>
	<!-- /container -->

<!--- second container -  bottom notifications --->
	<div id="container-bottom" style="top:auto; left:0; bottom:0; margin:0 0 10px 10px;display: none">
		<div>
			<div style="float:left;margin:0 10px 10px 10px"><img src="@{'/public/images/info-icon.png'}" alt="info" /></div>
			<p>INFO!</p>
			<p>Another user is currently updating the board!</p>
		</div>
	</div>
	
	<script type="text/javascript" charset="utf-8">
	
	if ($.browser.msie) {
		alert("Looks like you are using Internet Explorer, this site only works with Chrome, Firefox or Safari!");
	}
	
	$(function() {
		$('a[rel=popover]').popover({
			html:true,
       
		}).click(function(e) {
			$(this).popover('hide');
		})
	})
	
	function appendLINode(node, noteId, title, pos) {
		node.append('<li onmouseover="javascript:borderEffectAdd('+noteId+')" onmouseout="javascript:borderEffectRemove('+noteId+')" id="'+noteId+'" positionInRow="'+pos+'" class="note"><a id="del'+noteId+'" class="topCorner" onclick="javascript:deleteMe('+noteId+')" rel="popover" title="Delete Note" data-content="Click here to delete the note!" style="float: right;" href="#"><span class="closeMe">x</span></a><a class="edit'+noteId+'" id="fontme" rel="popover" onclick="javascript:editMe('+noteId+', \''+title+'\')" title="Edit Note" data-content="Click here to edit the note!" href="#">'+title+'</a></li>') 
		$("#del"+noteId).popover({offset: 10}).click(function(e) {
			$(this).popover('hide');
		});
		$(".edit"+noteId).popover({offset: 10}).click(function(e) {
			$(this).popover('hide');
		});
	}
	
	function create( template, vars, opts ){
		return $container.notify("create");
	}
			
	$(function() {
		
		$container = $("#container-bottom").notify({ stack:'above' });
		
		$("${cssStr}").sortable({
	        connectWith: '.connectedSortable',
	        placeholder: "placeHolderBG",
	        start: function(event, ui) {
	        	ui.placeholder.height(ui.item.height());
	            item = ui.item;
	            newList = oldList = ui.item.parent();
	            startIndex =  ui.item.index();
	        },
	        stop: function(event, ui) { 
	        	var noteId = item.attr('id');
	        	updateNotePos(noteId, startIndex, ui.item.index(), oldList.attr('cleanid'), newList.attr('cleanid'));
	        },
	        change: function(event, ui) {  
	            if(ui.sender) newList = ui.placeholder.parent();
	        }   
		});
		$("${cssStr}").disableSelection();
	});
	
	function borderEffectAdd(id) {
		document.getElementById(id).setAttribute("class", "uiEffects");
	}
	
	function borderEffectRemove(id) {
		document.getElementById(id).setAttribute("class", "note");
	}
	
	function deleteMe(noteId) {
		$.post('@{deleteNote()}', {
			noteId : noteId,
			identify: document.getElementById("identifyStr").value
		})
		
		$('#del'+noteId).popover('hide');
		$('li').remove('#'+noteId);
	}
	
	function editMe(noteId, title) {
		
		var newTitlePrompt = prompt('Change title?', title);
		
		if(newTitlePrompt != null && newTitlePrompt != '') {
		
		$.post('@{editNote()}', {
			noteId: noteId,
			newTitle: newTitlePrompt,
			identify: document.getElementById("identifyStr").value
			}, function(task) {
				if(task.title != null && task.title != '')
					$('a.edit'+noteId).text(task.title);
			
		}, 'json')
		
		}
	}

	function toggleAdd(str) {
		document.getElementById("addToggle" + str).style.display = "block";
		document.getElementById("addNoteToggle" + str).style.display = "none";
		document.getElementById("addnote" + str).focus();
	}

	function updateNotePos(noteId, startUiIndex, stopUiIndex, fromList,
			toList) {
		$.post('@{updateNotePosition()}', {
			noteId : noteId,
			startUiIndex : startUiIndex,
			stopUiIndex : stopUiIndex,
			fromList : fromList,
			toList : toList,
			identify: document.getElementById("identifyStr").value
		})
		
		var incVal = 0;
		
		// A list have lost an element lets give it new position
		// values
		if(fromList != toList) {
			$("ul#sortable"+fromList).children('li').each(function(newPos, elm) {  
				  elm.setAttribute("positionInRow", incVal++);
			});
		}	
	}

	function onKeyChange(evt) {
	   var charCode = (evt.which) ? evt.which : window.event.keyCode; 
		if (charCode == 13) { 
    		var idTmp = evt.target.id;
			idTmp = idTmp.replace("addnote", "");
			sendIt(idTmp);
	        return false;
	    }
	    else {
	        return true;
    	}
	}
	
	function sendIt(str) {
		var tmp = "addnote" + str;
		var tmp2 = ".posRow" + str;
		var tmp3 = "addToggle" + str;
		var tmp4 = "addNoteToggle" + str;
		
		if(document.getElementById(tmp).value != '') {
			$.post('@{addNewNote()}', {
				id : str,
				title : document.getElementById(tmp).value,
				text : "",
				identify: document.getElementById("identifyStr").value
			}, function(jsonNote) {
				appendLINode($(tmp2), jsonNote.id, jsonNote.title, jsonNote.positionInRow);
				}, 'json')
			
			
			document.getElementById(tmp).value = '';
			document.getElementById(tmp3).style.display = "none";
			document.getElementById(tmp4).style.display = "inline";
		}
	}
	
	var newDate = new Date;
	document.getElementById("identifyStr").value = newDate.getTime();
	
	// Create a pusher   
	var pusher = new Pusher('b1c3016f99b90a7db7de');
    var channel = pusher.subscribe('kanbanchannel');
   
		// Message received on the pusher channel
    	channel.bind('kanbanevent', function(data) {
    	var dataTmp = data.split(";");
		var type = dataTmp[0];
		var identify = dataTmp[1];
		
    	// On call if client is a receiver in websocket listen
    	if(document.getElementById("identifyStr").value != identify) {
    		
			create("container-bottom", { });
				
			if(type == "delete") {
				var noteId = dataTmp[2];
				$('li').remove('#'+noteId);
			
			} else if(type == "add") {
				var noteRowId = dataTmp[2];
				var title = dataTmp[3];
				var noteID = dataTmp[4];
				var positionInRow = dataTmp[5];
				var tmp2 = ".posRow" + noteRowId;

				appendLINode($(tmp2), noteID, title, positionInRow);
			
			} else if(type == "update") {
				var noteId = dataTmp[2];
				var title = dataTmp[3];
				
				$('a.edit'+noteId).replaceWith(title)
				
			} else if(type == "moved") {
				var id = dataTmp[2];
				var title = dataTmp[3];
				var to = dataTmp[4];
				var from = dataTmp[5];
				var positionInRow = dataTmp[6];
				
				// TODO: Refactor and optimize the code below
				$('li').remove('#'+id);
					
					appendLINode($(".posRow" + to), id, title, positionInRow);
					// Iterate over list and change positionValue
					$("ul#sortable"+to).children('li').each(function(newPos, elm) {  
						  if(elm.getAttribute("positionInRow") >= positionInRow && elm.getAttribute("id") != id) {
						     var newPosTmp = parseInt(elm.getAttribute("positionInRow")) + 1;
						 	 elm.setAttribute("positionInRow", newPosTmp);
						  }
					});
					
					// Sort the new list that received a new element
					$("ul#sortable"+to+">li").tsort({order:'asc',attr:'positionInRow'});
					
					var incVal = 0;
					// A list have lost an element lets give it new position
					// values
					if(from != to) {
						$("ul#sortable"+from).children('li').each(function(newPos, elm) {  
							  elm.setAttribute("positionInRow", incVal++);
						});
					}	
				}
    		}
		});
	</script>